<!doctype html>
<html lang="zh">
<head>
    <title>EC商城</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../Resource/css/styles.css">
    <link rel="stylesheet" type="text/css" href="../Resource/css/PROList.css"  />
	<link rel="stylesheet" type="text/css" href="../Resource/css/Car.css"  />
    <link rel="stylesheet" href="../Resource/css/flickity-docs.css" media="screen" />
</head>
<script src="../Resource/js/jquery-1.11.0.min.js" type="text/javascript"></script>
<script type="text/javascript">

    function init(){
        //載入header        
        $("#header").load( "Header.html");
        //載入footer
        $("#footer").load( "Footer.html");
        //取得商品分類
        getCate();
    }

    //取得商品分類
    function getCate(){    
        $.ajax({            
            method: "POST",
            url: "API/Category.php",
            data:{},            
            dataType: "json",
            success: function (response) {                
                showCate(response);                
            },
            error: function(exception) {
                alert("數據載入失敗: " + exception.status);
            }
        });
    }

    //顯示商品分類
    function showCate(response){
        $("#category").append(
            "<li></li>" +
            "<li><a href='Product.html'>所有商品</a></li>"
        );

        //更新html內容(透過jQuery跑迴圈取值)
        $.each(response, function(index, row) {
            $("#category").append(
                "<li><a href='Product.html?CID=" + row.ID + "'>" + row.Name + "</a></li>"
            );
        });

        $("#category").append(
            "<li><a href='Order.html'>我的消費紀錄</a></li>"       
        );

        //顯示會員資訊
        showMember();
    }

    //顯示會員資訊
    function showMember(){
        $.ajax({            
            method: "POST",
            url: "API/Member.php",
            data:{},            
            dataType: "text",
            success: function (response) {                           
                //寬版顯示>>Header.html
                $("#category").append(                    
                    "<li class='point___mobi'>" + response + "</li>"
                );
                //窄版顯示>>Header.html
                $("#showMember").html("<b>" + response + "</b>"); 
                
                //取得商品資訊
                getData();
            },
            error: function(exception) {
                alert("數據載入失敗: " + exception.status);
            }
        });
    }

    //------------------------------------------------------------------------
    
    //取得商品資訊
    function getData(){  
        
        //在html頁面上取得GET(QueryString)的值
        var CID = (new URL(location.href)).searchParams.get('CID');

        $.ajax({            
            method: "POST",
            url: "API/Product.php",
            data:{CID: CID},          
            dataType: "json",
            success: function (response) {                
                display(response);                
            },
            error: function(exception) {
                alert("數據載入失敗: " + exception.status);
            }
        });
    }

    //顯示商品資訊
    function display(response){
        //更新html內容(透過jQuery跑迴圈取值)
        $.each(response, function(index, row) {
            $("#product").append(
                "<div class='product-list'>" +
                "<img src='../Upload/" + row.PictureName + "' width='200' height='200'/>" +
		        "<div class='name'>" + row.ProductName + "</div>" +
                "<div class='price'>售價: " + row.Price + "</div>" +
			    "<div class='all_'>" +
				    "<select id='qty_" + row.ID + "' name='qty_" + row.ID + "'>" +
                        "<option value='0'>0</option>" +
                        "<option value='1'>1</option>" +
                        "<option value='2'>2</option>" +
                        "<option value='3'>3</option>" +                   
                        "<option value='4'>4</option>" +
                        "<option value='5'>5</option>" +
				    "</select>" +
				    "<input type='button' value='加入購物車' class='sami btnMoveToCart' onclick=\"loginCheck('" + row.ID + "')\">" +
	    	    "</div>" +
                "</div>"
            );            
        });
    }

    //登入檢查 ---------------------------------------------------------------------------------
    function loginCheck(pid){    
        $.ajax({            
            method: "POST",
            url: "API/LoginCheck.php",
            data:{},            
            dataType: "text",
            success: function (response) {
                if(response == ""){
                    //尚未登入->前往Login.php
                    alert('請先登入，將前往登入頁'); 
                    location.href = 'Login.html';
                }else{
                    addToCart(pid)
                }              
            },
            error: function(exception) {
                alert("數據載入失敗: " + exception.status);
            }
        });
    }

    //加入購物車 ---------------------------------------------------------------------------------
    function addToCart(pid) {        
        var qty = document.getElementById('qty_' + pid).value;

        if (qty=='0') {
            alert("請選擇數量!");
            return false;
        }

        $.ajax({            
            method: "POST",
            url: "API/AddToCart.php",
            data:{ 
                PID: pid,
                QTY: qty
            },            
            dataType: "text",
            success: function (response) {
                //加入購物車成功
                alert(response);             
            },
            error: function(exception) {
                alert("加入購物車失敗: " + exception.status);
            }
        });
    }

</script>

<body onload="init()">

<div id="header"></div>

<form id="fm">

    <div class="WishList" id="product">		       

        <!--產品呈現區-->

    </div>

</form>

<div id="footer"></div>

</body>
</html>
